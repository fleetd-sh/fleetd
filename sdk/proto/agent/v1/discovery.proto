syntax = "proto3";

package fleetd.agent.v1;

option go_package = "fleetd.sh/gen/agent/v1;agentpb";

import "google/protobuf/timestamp.proto";

// DiscoveryService handles device discovery on local networks
service DiscoveryService {
  // Announce device presence on the network
  rpc Announce(AnnounceRequest) returns (AnnounceResponse);

  // Discover devices on the local network
  rpc Discover(DiscoverRequest) returns (stream DiscoverResponse);

  // Pair a discovered device with the fleet
  rpc Pair(PairRequest) returns (PairResponse);
}

// AnnounceRequest announces device presence
message AnnounceRequest {
  string device_name = 1;
  string device_type = 2;
  string hardware_id = 3;
  string ip_address = 4;
  int32 port = 5;
  map<string, string> capabilities = 6;
  bool requires_pairing = 7;
}

// AnnounceResponse confirms announcement
message AnnounceResponse {
  string announcement_id = 1;
  int32 ttl_seconds = 2;  // Time before re-announcement needed
}

// DiscoverRequest initiates device discovery
message DiscoverRequest {
  string requester_id = 1;
  int32 timeout_seconds = 2;
  repeated string device_types = 3;  // Filter by device types
  map<string, string> filters = 4;   // Additional filters
}

// DiscoverResponse streams discovered devices
message DiscoverResponse {
  DiscoveredDevice device = 1;
}

// PairRequest pairs a discovered device
message PairRequest {
  string requester_id = 1;
  string device_id = 2;
  string pairing_code = 3;  // Code shown on device or generated
  map<string, string> metadata = 4;
}

// PairResponse contains pairing result
message PairResponse {
  bool success = 1;
  string device_id = 2;
  string device_token = 3;
  string api_endpoint = 4;
  string message = 5;
}

// DiscoveredDevice represents a discovered device
message DiscoveredDevice {
  string id = 1;
  string name = 2;
  string type = 3;
  string ip_address = 4;
  int32 port = 5;
  bool paired = 6;
  bool requires_pairing = 7;
  map<string, string> capabilities = 8;
  google.protobuf.Timestamp discovered_at = 9;
}