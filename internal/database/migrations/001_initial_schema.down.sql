-- Consolidated FleetD Database Schema - Down Migration
-- This drops all tables created in the consolidated schema

-- Drop indexes first (some databases require this)
DROP INDEX IF EXISTS idx_token_blacklist_expires;
DROP INDEX IF EXISTS idx_token_blacklist_hash;
DROP INDEX IF EXISTS idx_role_permissions_permission;
DROP INDEX IF EXISTS idx_role_permissions_role;
DROP INDEX IF EXISTS idx_user_roles_role;
DROP INDEX IF EXISTS idx_user_roles_user;
DROP INDEX IF EXISTS idx_user_role_role;
DROP INDEX IF EXISTS idx_user_role_user;
DROP INDEX IF EXISTS idx_roles_name;
DROP INDEX IF EXISTS idx_auth_audit_resource;
DROP INDEX IF EXISTS idx_auth_audit_action;
DROP INDEX IF EXISTS idx_auth_audit_user;
DROP INDEX IF EXISTS idx_audit_log_resource;
DROP INDEX IF EXISTS idx_audit_log_action;
DROP INDEX IF EXISTS idx_audit_log_timestamp;
DROP INDEX IF EXISTS idx_audit_log_device;
DROP INDEX IF EXISTS idx_audit_log_user;
DROP INDEX IF EXISTS idx_access_token_expires;
DROP INDEX IF EXISTS idx_access_token;
DROP INDEX IF EXISTS idx_device_auth_expires;
DROP INDEX IF EXISTS idx_device_user_code;
DROP INDEX IF EXISTS idx_device_auth_code;
DROP INDEX IF EXISTS idx_api_key_expires;
DROP INDEX IF EXISTS idx_api_key_hash;
DROP INDEX IF EXISTS idx_api_key_device;
DROP INDEX IF EXISTS idx_api_key_user;
DROP INDEX IF EXISTS idx_sessions_expires;
DROP INDEX IF EXISTS idx_sessions_token;
DROP INDEX IF EXISTS idx_sessions_user;
DROP INDEX IF EXISTS idx_session_refresh_token;
DROP INDEX IF EXISTS idx_session_expires;
DROP INDEX IF EXISTS idx_session_user;
DROP INDEX IF EXISTS idx_user_account_role;
DROP INDEX IF EXISTS idx_user_account_email;
DROP INDEX IF EXISTS idx_user_deleted_at;
DROP INDEX IF EXISTS idx_user_status;
DROP INDEX IF EXISTS idx_user_username;
DROP INDEX IF EXISTS idx_user_email;
DROP INDEX IF EXISTS idx_webhook_delivery_webhook;
DROP INDEX IF EXISTS idx_webhook_active;
DROP INDEX IF EXISTS idx_notification_status;
DROP INDEX IF EXISTS idx_notification_recipient;
DROP INDEX IF EXISTS idx_command_log_device;
DROP INDEX IF EXISTS idx_command_log_command;
DROP INDEX IF EXISTS idx_command_status;
DROP INDEX IF EXISTS idx_command_fleet;
DROP INDEX IF EXISTS idx_command_device;
DROP INDEX IF EXISTS idx_alert_severity;
DROP INDEX IF EXISTS idx_alert_status;
DROP INDEX IF EXISTS idx_alert_fleet;
DROP INDEX IF EXISTS idx_alert_device;
DROP INDEX IF EXISTS idx_alerts_unresolved;
DROP INDEX IF EXISTS idx_alerts_source;
DROP INDEX IF EXISTS idx_alerts_severity;
DROP INDEX IF EXISTS idx_health_checks_status;
DROP INDEX IF EXISTS idx_health_checks_name;
DROP INDEX IF EXISTS idx_health_check_device;
DROP INDEX IF EXISTS idx_metric_aggregate_period;
DROP INDEX IF EXISTS idx_metric_aggregate_fleet;
DROP INDEX IF EXISTS idx_metric_aggregate_device;
DROP INDEX IF EXISTS idx_metric_type_timestamp;
DROP INDEX IF EXISTS idx_metric_device_timestamp;
DROP INDEX IF EXISTS idx_delta_versions;
DROP INDEX IF EXISTS idx_downloads_time;
DROP INDEX IF EXISTS idx_downloads_device;
DROP INDEX IF EXISTS idx_downloads_artifact;
DROP INDEX IF EXISTS idx_artifacts_uploaded;
DROP INDEX IF EXISTS idx_artifacts_type;
DROP INDEX IF EXISTS idx_artifacts_name_version;
DROP INDEX IF EXISTS idx_rollback_deployment;
DROP INDEX IF EXISTS idx_snapshots_deployment;
DROP INDEX IF EXISTS idx_deployment_health_time;
DROP INDEX IF EXISTS idx_campaign_metrics_name;
DROP INDEX IF EXISTS idx_campaign_metrics_campaign;
DROP INDEX IF EXISTS idx_device_campaign_device;
DROP INDEX IF EXISTS idx_device_campaign_status;
DROP INDEX IF EXISTS idx_campaign_status;
DROP INDEX IF EXISTS idx_campaign_deployment;
DROP INDEX IF EXISTS idx_deployment_event_created;
DROP INDEX IF EXISTS idx_deployment_event_device;
DROP INDEX IF EXISTS idx_deployment_event_deployment;
DROP INDEX IF EXISTS idx_device_deployment_status;
DROP INDEX IF EXISTS idx_device_deployment_device;
DROP INDEX IF EXISTS idx_deployment_namespace;
DROP INDEX IF EXISTS idx_deployment_update;
DROP INDEX IF EXISTS idx_deployment_status;
DROP INDEX IF EXISTS idx_update_package_status;
DROP INDEX IF EXISTS idx_device_health_status;
DROP INDEX IF EXISTS idx_device_health_time;
DROP INDEX IF EXISTS idx_device_system_info_device;
DROP INDEX IF EXISTS idx_device_group_member_group;
DROP INDEX IF EXISTS idx_device_group_member_device;
DROP INDEX IF EXISTS idx_device_fleet_member_fleet;
DROP INDEX IF EXISTS idx_device_fleet_member_device;
DROP INDEX IF EXISTS idx_device_fleet_deleted_at;
DROP INDEX IF EXISTS idx_device_fleet_name;
DROP INDEX IF EXISTS idx_device_api_key;
DROP INDEX IF EXISTS idx_device_type;
DROP INDEX IF EXISTS idx_device_deleted_at;
DROP INDEX IF EXISTS idx_device_created_at;
DROP INDEX IF EXISTS idx_device_last_seen;
DROP INDEX IF EXISTS idx_device_status;

-- Drop tables in reverse dependency order
DROP TABLE IF EXISTS role_policy;
DROP TABLE IF EXISTS policy;
DROP TABLE IF EXISTS role_permissions;
DROP TABLE IF EXISTS user_roles;
DROP TABLE IF EXISTS user_role;
DROP TABLE IF EXISTS roles;
DROP TABLE IF EXISTS role;
DROP TABLE IF EXISTS token_blacklist;
DROP TABLE IF EXISTS auth_audit_log;
DROP TABLE IF EXISTS audit_log;
DROP TABLE IF EXISTS access_token;
DROP TABLE IF EXISTS device_auth_request;
DROP TABLE IF EXISTS api_key;
DROP TABLE IF EXISTS sessions;
DROP TABLE IF EXISTS session;
DROP TABLE IF EXISTS user_account;
DROP TABLE IF EXISTS "user";
DROP TABLE IF EXISTS webhook_delivery;
DROP TABLE IF EXISTS webhook;
DROP TABLE IF EXISTS notification;
DROP TABLE IF EXISTS command_log;
DROP TABLE IF EXISTS command;
DROP TABLE IF EXISTS alert;
DROP TABLE IF EXISTS health_alerts;
DROP TABLE IF EXISTS health_checks;
DROP TABLE IF EXISTS health_check;
DROP TABLE IF EXISTS metric_aggregate;
DROP TABLE IF EXISTS metric;
DROP TABLE IF EXISTS delta_artifacts;
DROP TABLE IF EXISTS artifact_downloads;
DROP TABLE IF EXISTS artifacts;
DROP TABLE IF EXISTS rollback_history;
DROP TABLE IF EXISTS deployment_snapshots;
DROP TABLE IF EXISTS rollback_policies;
DROP TABLE IF EXISTS deployment_health;
DROP TABLE IF EXISTS campaign_metrics;
DROP TABLE IF EXISTS device_campaign_state;
DROP TABLE IF EXISTS campaign;
DROP TABLE IF EXISTS deployment_event;
DROP TABLE IF EXISTS device_deployment;
DROP TABLE IF EXISTS deployment;
DROP TABLE IF EXISTS update_package;
DROP TABLE IF EXISTS device_health;
DROP TABLE IF EXISTS device_system_info;
DROP TABLE IF EXISTS device_group_member;
DROP TABLE IF EXISTS device_group;
DROP TABLE IF EXISTS device_fleet_member;
DROP TABLE IF EXISTS device_fleet;
DROP TABLE IF EXISTS device;